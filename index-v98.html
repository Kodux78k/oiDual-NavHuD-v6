<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // FUSION OS — Morph & Stagger (clean)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#05070a">

  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW registered')).catch(()=>{});
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- html2canvas para export PNG (mantido) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg-deep:#030406; --glass-surface:rgba(18,18,22,0.65); --glass-border:rgba(255,255,255,0.06);
      --neon-cyan:#00f2ff; --neon-purple:#bd00ff; --neon-orange:#ff9a3c;
      --font-ui:'Montserrat',sans-serif; --font-code:'JetBrains Mono',monospace;
      --ease-overshoot: cubic-bezier(0.34, 1.3, 0.64, 1);
      --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;user-select:none}
    body{margin:0;padding:0;min-height:100vh;background-color:var(--bg-deep);color:#fff;
      font-family:var(--font-ui);display:flex;align-items:center;justify-content:center;overflow:hidden;
      background-image:linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size:50px 50px;
    }

    .ambient-light{position:fixed;inset:0;z-index:0;pointer-events:none}
    .blob{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.14;animation:float 25s infinite alternate ease-in-out}
    .blob-1{width:60vw;height:60vw;background:var(--neon-cyan);top:-20%;left:-20%}
    .blob-2{width:50vw;height:50vw;background:var(--neon-purple);bottom:-20%;right:-20%;animation-delay:-5s}
    @keyframes float{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}

    .container{width:100%;max-width:640px;padding:20px;z-index:10;perspective:1200px;display:flex;align-items:center;justify-content:center}

    .fusion-card{width:100%; max-width:440px;background:var(--glass-surface);backdrop-filter:blur(30px);
      border:1px solid var(--glass-border);border-radius:36px;padding:30px 25px;box-shadow:0 40px 100px rgba(0,0,0,0.8);
      position:relative;overflow:hidden;opacity:0; transform:translateY(50px) scale(0.96);display:flex;flex-direction:column;gap:8px;
    }
    .fusion-card.active{opacity:1;transform:translateY(0) scale(1); transition: opacity 0.6s, transform 0.6s var(--ease-smooth);}

    .fusion-card.closed{width:260px;padding:14px 16px;border-radius:22px;box-shadow:0 22px 70px rgba(0,0,0,0.75);cursor:pointer;}
    .fusion-card.closed .card-body{display:none}
    .fusion-card.animating{transition:none !important}

    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:18px}
    .avatar-slot{width:64px;height:64px;border-radius:12px;overflow:hidden;opacity:0;transition:opacity 0.35s}
    .avatar-slot.shown{opacity:1}
    .text-block{flex:1;display:flex;flex-direction:column;justify-content:center}
    .greeting-row{font-size:1.5rem;line-height:1;display:flex;align-items:baseline;gap:6px;flex-wrap:wrap}
    .txt-thin{font-weight:200;color:rgba(255,255,255,0.7)}
    .txt-heavy{font-weight:600;color:#fff}
    .brand-dual{font-size:2.2rem;font-weight:900;line-height:0.95;text-transform:uppercase;letter-spacing:-2px;margin-top:4px;
      background:linear-gradient(-45deg,#fff,var(--neon-cyan),var(--neon-purple),#fff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradientFlow 4s ease infinite;
    }
    @keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .clock-widget{text-align:right}
    .time-display{font-family:var(--font-code);font-size:1rem;color:rgba(255,255,255,0.5);font-weight:700}
    .status-led{font-size:0.6rem;color:var(--neon-cyan);text-transform:uppercase;letter-spacing:1px;margin-top:4px;display:block}

    .card-body{display:flex;flex-direction:column;gap:12px}
    .stagger-item{opacity:0;transform:translateY(15px);transition:opacity 0.4s ease, transform 0.4s var(--ease-overshoot)}
    .content-visible .stagger-item{opacity:1;transform:translateY(0)}
    .content-visible .stagger-item:nth-child(1){transition-delay:0.1s}
    .content-visible .stagger-item:nth-child(2){transition-delay:0.18s}
    .content-visible .stagger-item:nth-child(3){transition-delay:0.25s}

    .cyber-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 50px 16px 18px;color:#fff;font-family:var(--font-code);font-size:0.9rem}
    .trigger-btn{width:100%;padding:12px;border:1px dashed rgba(255,255,255,0.1);border-radius:12px;background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.5);font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px}
    .trigger-btn:hover{background:rgba(255,255,255,0.04);color:#fff;border-color:rgba(255,255,255,0.3)}

    .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
    .stat-box{background:rgba(255,255,255,0.03);border-radius:12px;padding:10px;text-align:center}
    .stat-lbl{font-size:0.55rem;text-transform:uppercase;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px}
    .stat-val{font-family:var(--font-code);font-size:0.9rem;font-weight:700;color:var(--neon-cyan)}

    .progress-container{background:rgba(0,0,0,0.2);padding:12px;border-radius:12px}
    .bar-track{height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin:8px 0}
    .bar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--neon-cyan),var(--neon-purple));box-shadow:0 0 10px var(--neon-cyan);transition:width 1.2s ease-out}
    .bar-meta{display:flex;justify-content:space-between;font-size:0.6rem;color:rgba(255,255,255,0.4);font-family:var(--font-code)}

    .small-preview{display:none;align-items:center;gap:10px;margin-top:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-family:var(--font-code);font-size:0.86rem;color:rgba(255,255,255,0.9);cursor:pointer;overflow:hidden}
    .small-preview .mini-avatar{width:30px;height:30px;border-radius:6px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center}
    .small-preview .small-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 110px)}
    .small-preview .ident-badge{margin-left:auto;font-weight:700;font-size:0.78rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.02)}
    .fusion-card.closed .small-preview{display:flex}

    .vibe-gold{box-shadow:0 0 0px rgba(255,210,80,0.0);animation:vibePulse 1.6s infinite;border:1px solid rgba(255,210,80,0.15)}
    @keyframes vibePulse{0%{box-shadow:0 0 0 0 rgba(255,210,80,0.0);transform:translateY(0)}40%{box-shadow:0 0 18px 6px rgba(255,210,80,0.06);transform:translateY(-1px) scale(1.01)}100%{box-shadow:0 0 0 0 rgba(255,210,80,0.0);transform:translateY(0)}}

    .activation-wrap{display:flex;flex-direction:column;gap:8px}
    .activation-card{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;overflow:hidden;transition:all 320ms var(--ease-smooth)}
    .activation-pre{font-family:var(--font-code);white-space:pre-wrap;margin:0;padding:8px;background:rgba(0,0,0,0.12);border-radius:8px;border:1px dashed rgba(255,255,255,0.03);color:#fff}
    .activation-hidden{max-height:0;opacity:0;padding:0 12px;pointer-events:none}
    .activation-open{max-height:400px;opacity:1;padding:12px}

    /* TOASTER (placeholder, implementação futura) */
    .toaster-wrap{position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toaster{pointer-events:auto;background:linear-gradient(180deg,#0b1220,#071018);border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.6);font-family:var(--font-ui);font-size:0.95rem;opacity:0;transform:translateY(8px);transition:all 260ms var(--ease-smooth)}
    .toaster.show{opacity:1;transform:translateY(0)}

    .activation-controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}

    @media (max-width:420px){ .fusion-card.closed{width:220px} .brand-dual{font-size:1rem} }
  </style>
</head>
<body>
  <div class="ambient-light"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

  <div class="container">
    <div class="fusion-card closed" id="mainCard" aria-expanded="false">
      <div class="card-header" id="cardHeader" role="button" tabindex="0" aria-controls="cardBody" aria-expanded="false">
        <div class="avatar-slot" id="avatarTarget" aria-hidden="true"></div>

        <div class="text-block">
          <div class="greeting-row">
            <span class="txt-thin" id="lblHello">Sistema</span>
            <span class="txt-heavy" id="lblName">Convidado</span>
          </div>
          <div class="brand-dual">DUAL</div>
        </div>

        <div class="clock-widget" aria-hidden="true">
          <div class="time-display" id="clockTime">00:00</div>
          <span class="status-led">ONLINE</span>
        </div>
      </div>

      <div class="small-preview" id="smallPreview" title="Clique para abrir e editar a ativação">
        <div class="mini-avatar" id="smallMiniAvatar" aria-hidden="true"></div>
        <div class="small-text" id="smallText">Ativação aparecerá aqui</div>
        <div class="ident-badge" id="smallIdent">--</div>
      </div>

      <div class="card-body" id="cardBody">
        <div class="input-wrapper stagger-item">
          <input type="text" class="cyber-input" id="inputUser" placeholder="Identifique-se..." autocomplete="off" />
        </div>

        <!-- ASCII Activation (foco principal) -->
        <div class="activation-wrap stagger-item">
          <div class="activation-toggle" id="activationToggle" onclick="toggleActivation()">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:10px;height:10px;border-radius:99px;background:var(--neon-cyan)"></div>
              <strong style="letter-spacing:1px">Ativação ASCII</strong>
            </div>
            <div style="margin-left:auto;font-size:0.82rem;color:rgba(255,255,255,0.6)">BASE v1</div>
          </div>

          <div id="activationCard" class="activation-card activation-hidden">
            <div style="display:flex;align-items:flex-start;gap:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <div class="mini-avatar" id="actMiniAvatar"></div>
                <div style="display:flex;flex-direction:column;">
                  <div id="actTitle" style="font-weight:700">CÉREBRO-ORÁCULO — BASE v1</div>
                  <div style="font-size:0.78rem;color:rgba(255,255,255,0.55)">Ativar: <span id="actName">(Convidado).Dual Infodose</span></div>
                </div>
              </div>
              <div style="margin-left:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                <div class="activation-badge" id="actBadge">v:--</div>
                <div style="font-size:0.72rem;color:rgba(255,255,255,0.45)">Rolling system</div>
              </div>
            </div>

            <pre id="actPre" class="activation-pre" aria-live="polite">
+------------------------------+
| CÉREBRO-ORÁCULO — BASE v1    |
+------------------------------+
Ativar: (Convidado).Dual Infodose
            </pre>

            <div class="activation-controls">
              <button class="trigger-btn" id="copyActBtn" type="button">COPIAR</button>
              <button class="trigger-btn" id="downloadActBtn" type="button">EXPORT PNG</button>
            </div>
          </div>
        </div>

        <div class="stagger-item">
          <div class="stats-grid">
            <div class="stat-box"><span class="stat-lbl">LATÊNCIA</span><span class="stat-val">12ms</span></div>
            <div class="stat-box"><span class="stat-lbl">CPU</span><span class="stat-val">FUSION</span></div>
            <div class="stat-box"><span class="stat-lbl">RITMO</span><span class="stat-val">BETA</span></div>
          </div>

          <div class="progress-container" style="margin-top:12px">
            <div class="bar-meta"><span>CICLO DIÁRIO</span><span id="cyclePercent">0%</span></div>
            <div class="bar-track"><div class="bar-fill" id="cycleFill"></div></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- TOASTER placeholder -->
  <div class="toaster-wrap" id="toasterWrap"></div>

  <script>
    lucide.createIcons();

    const els = {
      card: document.getElementById('mainCard'),
      header: document.getElementById('cardHeader'),
      avatarTgt: document.getElementById('avatarTarget'),
      input: document.getElementById('inputUser'),
      lblHello: document.getElementById('lblHello'),
      lblName: document.getElementById('lblName'),
      clock: document.getElementById('clockTime'),
      smallPreview: document.getElementById('smallPreview'),
      smallMiniAvatar: document.getElementById('smallMiniAvatar'),
      smallText: document.getElementById('smallText'),
      smallIdent: document.getElementById('smallIdent'),
      activationCard: document.getElementById('activationCard'),
      actPre: document.getElementById('actPre'),
      actName: document.getElementById('actName'),
      actMiniAvatar: document.getElementById('actMiniAvatar'),
      actBadge: document.getElementById('actBadge'),
      copyActBtn: document.getElementById('copyActBtn'),
      downloadActBtn: document.getElementById('downloadActBtn')
    };

    // --- AVATAR helpers ---
    function createAvatarSVG(id, size = 64){
      return `
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" aria-hidden="true">
          <defs>
            <linearGradient id="g${id}" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#00f2ff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#bd00ff;stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="48" fill="#080b12" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
          <circle cx="50" cy="50" r="20" fill="url(#g${id})" opacity="0.9"/>
        </svg>
      `;
    }
    function hashString(str){
      let h = 2166136261 >>> 0;
      for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619) >>> 0; }
      return h >>> 0;
    }
    function seedToGradient(seed, id='s'){
      const h1 = seed % 360; const h2 = (seed * 37) % 360;
      return {id: `gSmall${id}`, svg: `<linearGradient id="gSmall${id}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="hsl(${h1} 100% 55%)"/><stop offset="100%" stop-color="hsl(${h2} 90% 45%)"/></linearGradient>`};
    }
    function makeMiniAvatarHTML(name, size = 30){
      const seed = hashString(name || 'DUAL');
      const grad = seedToGradient(seed, seed.toString(36));
      return `
        <svg width="${size}" height="${size}" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>${grad.svg}</defs>
          <rect x="0" y="0" width="32" height="32" rx="6" fill="#071018" />
          <circle cx="16" cy="12" r="6" fill="url(#${grad.id})"/>
          <path d="M16 24 a8 4 0 0 1 8 -4" stroke="rgba(255,255,255,0.06)" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
      `;
    }

    els.avatarTgt.innerHTML = createAvatarSVG('B',64);

    // --- small preview / 369 root ---
    function reduce369Short(name){
      if(!name || !name.trim()) return '--';
      const s = name.split('').reduce((acc,ch)=> acc + ch.charCodeAt(0), 0);
      let root = s;
      while(root > 9) root = String(root).split('').reduce((a,b)=>a+Number(b), 0);
      return root;
    }
    function updateSmallPreviewFromName(name){
      const now = new Date();
      const PHRASES_24 = [
        "Ativar foco estável.","Sintonizar ritmo criativo.","Amplificar percepção sutil.","Conectar ao core de coesão.",
        "Iniciar limpeza cognitiva.","Engatar modo produtividade.","Equilibrar fluxo emocional.","Elevar nível de curiosidade.",
        "Refinar intenção principal.","Fortalecer memória ativa.","Sincronizar com ciclo terrestre.","Ativar shield de atenção.",
        "Optimizar caminhos de decisão.","Despertar intuição prática.","Atenuar ruídos internos.","Mapear prioridades do dia.",
        "Habilitar modo aprendizado.","Sintonizar voz interior clara.","Aumentar resiliência mental.","Abrir canal de insights.",
        "Energetizar campo criativo.","Ancorar objetivos curtos.","Preparar para execução suave.","Concluir com gratidão."
      ];
      const phrase = PHRASES_24[now.getHours() % 24];
      const miniText = (name && name.trim()) ? `${name.trim()} · ${phrase}` : `Ativação aparecerá aqui`;
      els.smallText.innerText = miniText;
      const root = reduce369Short(name);
      els.smallIdent.innerText = (name && name.trim()) ? `v:${root}` : '--';
      els.smallPreview.classList.remove('vibe-gold');
      if(root === 3 || root === 6 || root === 9) els.smallPreview.classList.add('vibe-gold');
      els.smallMiniAvatar.innerHTML = makeMiniAvatarHTML(name || 'DUAL',30);
      updateActivationBlock(name || 'Convidado');
    }

    // --- ASCII Activation generator ---
    function createAsciiActivation(name){
      const displayName = name && name.trim() ? `${name.trim()}.Dual Infodose` : '(Convidado).Dual Infodose';
      const root = reduce369Short(name);
      const title = 'CÉREBRO-ORÁCULO — BASE v1';
      const content = `Ativar: ${displayName}`;
      const width = Math.max(title.length, content.length) + 4;
      const top = '+' + '-'.repeat(width) + '+';
      const midTitle = `| ${title.padEnd(width - 1)}|`;
      const top2 = '+' + '-'.repeat(width) + '+';
      const ascii = `${top}\n${midTitle}\n${top2}\n${content}\n`;
      return { ascii, displayName, root, title, content };
    }
    function updateActivationBlock(name){
      const r = createAsciiActivation(name);
      els.actPre.innerText = r.ascii;
      els.actName.innerText = r.displayName;
      els.actMiniAvatar.innerHTML = makeMiniAvatarHTML(name || 'DUAL',36);
      els.actBadge.innerText = `v:${r.root}`;
      els.actBadge.classList.remove('vibe-gold');
      if(r.root === 3 || r.root === 6 || r.root === 9) els.actBadge.classList.add('vibe-gold');
    }

    // --- TTS ---
    function speak(text){
      if(!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      if(!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR'; u.rate = 1.05;
      window.speechSynthesis.speak(u);
    }

    // --- init ---
    document.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>{ els.card.classList.add('active'); els.avatarTgt.classList.add('shown'); },120);
      const saved = localStorage.getItem('fusion_user');
      if(saved){ setUserName(saved); updateSmallPreviewFromName(saved); }
      else { updateSmallPreviewFromName(''); }
    });

    // --- morph toggle with TTS de boas-vindas (quando abre o card) ---
    function toggleCard(){
      if(els.card.classList.contains('animating')) return;
      const isOpening = els.card.classList.contains('closed');
      els.card.classList.add('animating');
      if(isOpening){
        // abrir
        els.card.classList.remove('closed');
        els.card.setAttribute('aria-expanded','true');
        const anim = els.card.animate([{transform:'scale(.995) translateY(6px)'},{transform:'scale(1) translateY(0)'}],{duration:600,easing:'cubic-bezier(.34,1.3,.64,1)',fill:'forwards'});
        anim.onfinish = ()=>{ els.card.classList.remove('animating'); els.card.classList.add('content-visible'); els.input.focus(); const name = els.input.value.trim() || localStorage.getItem('fusion_user') || 'Convidado'; speak(`Bem-vindo, ${name}. Ativação ASCII pronta.`); };
      } else {
        // fechar
        els.card.classList.remove('content-visible');
        const anim = els.card.animate([{transform:'scale(1) translateY(0)'},{transform:'scale(.995) translateY(6px)'}],{duration:420,easing:'cubic-bezier(.23,1,.32,1)',fill:'forwards'});
        anim.onfinish = ()=>{ els.card.classList.remove('animating'); els.card.classList.add('closed'); els.card.setAttribute('aria-expanded','false'); };
      }
    }

    els.header.addEventListener('click', toggleCard);
    els.header.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); toggleCard(); } });

    els.smallPreview.addEventListener('click', ()=>{
      if(els.card.classList.contains('closed')) toggleCard();
      else els.input.focus();
    });

    // input events
    els.input.addEventListener('input',(e)=>{
      const v = e.target.value;
      if(v){ els.lblHello.innerText='Oi,'; els.lblName.innerText = v; }
      else { els.lblHello.innerText='Sistema'; els.lblName.innerText='Convidado'; }
      updateSmallPreviewFromName(v);
    });
    els.input.addEventListener('blur',(e)=>{
      const v = e.target.value.trim();
      if(v){ localStorage.setItem('fusion_user', v); speak(`Usuário ${v} confirmado.`); updateSmallPreviewFromName(v); }
    });
    els.input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') e.target.blur(); });

    // activation accordion
    function toggleActivation(){
      els.activationCard.classList.toggle('activation-hidden');
      els.activationCard.classList.toggle('activation-open');
      if(!els.activationCard.classList.contains('activation-hidden')){
        // ao abrir ativação, lê em TTS a ativação ASCII curta
        speak(els.actPre.innerText.replace(/\n/g,' '));
      }
    }

    // clock + progress
    function updateMetrics(){ const now = new Date(); els.clock.innerText = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); const pct = Math.min(100, Math.max(0, ((now.getHours() + now.getMinutes()/60) / 24) * 100)); document.getElementById('cycleFill').style.width = `${pct}%`; document.getElementById('cyclePercent').innerText = `${Math.floor(pct)}%`; }
    setInterval(updateMetrics,1000); updateMetrics();

    // --- Toaster (placeholder) ---
    const toasterWrap = document.getElementById('toasterWrap');
    function showToaster(text, ms = 3200){
      const node = document.createElement('div'); node.className = 'toaster'; node.innerText = text + ' — (toaster: implementação futura)';
      toasterWrap.appendChild(node);
      requestAnimationFrame(()=> node.classList.add('show'));
      setTimeout(()=>{ node.classList.remove('show'); setTimeout(()=> node.remove(),300); }, ms);
    }

    // activation actions (copy + export)
    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return Promise.resolve();
    }
    els.copyActBtn.addEventListener('click', ()=>{ copyToClipboard(els.actPre.innerText).then(()=> showToaster('Ativação copiada')); });

    els.downloadActBtn.addEventListener('click', async ()=>{
      const el = document.getElementById('activationCard'); const prevHidden = el.classList.contains('activation-hidden'); if(prevHidden){ el.classList.remove('activation-hidden'); el.classList.add('activation-open'); }
      try {
        const canvas = await html2canvas(el, {backgroundColor:null, scale:2});
        const a = document.createElement('a'); a.download = `activation-${(new Date()).toISOString().replace(/[:.]/g,'')}.png`; a.href = canvas.toDataURL('image/png'); a.click();
      } catch(e){ console.error(e); showToaster('Erro exportando PNG'); }
      if(prevHidden){ el.classList.add('activation-hidden'); el.classList.remove('activation-open'); }
    });

    // user helpers
    function setUserName(name){ els.input.value = name; els.lblHello.innerText='Oi,'; els.lblName.innerText = name; updateSmallPreviewFromName(name); }
    const initial = localStorage.getItem('fusion_user'); if(initial) setUserName(initial);

    // keyboard accessibility: activation toggle keyboardable
    document.getElementById('activationToggle').setAttribute('tabindex','0');
    document.getElementById('activationToggle').addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); toggleActivation(); } });

  </script>
</body>
</html>